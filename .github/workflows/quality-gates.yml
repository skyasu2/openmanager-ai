name: Quality Gates (Type-Safe CI/CD)

# 🎯 타입 안전성 우선 CI/CD
# 목표: TypeScript 에러 0개 강제, 자동 상태 리포트

on:
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'Enable strict TypeScript checking'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read

env:
  NODE_VERSION: '24.x'

jobs:
  # 🔒 TypeScript 무결성 검증 (차단 가능)
  typescript-integrity:
    name: TypeScript Zero-Error Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript Strict Check
        run: |
          echo "🔍 TypeScript 무결성 검증 시작..."
          npm run type-check
          echo "✅ TypeScript 에러 0개 확인!"

      - name: Hook Dependencies Check
        run: |
          echo "🔄 정적 품질 체크..."
          npm run check
          echo "✅ 정적 품질 체크 통과"

  # 📊 상태 리포트
  status-report:
    name: Quality Status Report
    runs-on: ubuntu-latest
    needs: [typescript-integrity]
    if: always()
    steps:
      - name: Write Summary
        run: |
          echo "# Quality Gates Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- TypeScript gate: ${{ needs.typescript-integrity.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Trigger: ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"

  # 🔍 아키텍처 건강성 체크
  architecture-health:
    name: Architecture Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Component Complexity Analysis
        run: |
          echo "🏗️ 컴포넌트 복잡도 분석..."

          # 대형 컴포넌트 탐지 (500줄 이상)
          large_components=$(find src/components -name "*.tsx" -exec wc -l {} + | awk '$1 > 500 {print $2 " (" $1 " lines)"}')

          if [ -n "$large_components" ]; then
            echo "⚠️ 대형 컴포넌트 발견:"
            echo "$large_components"
            echo "💡 리팩토링 권장: 500줄 이하로 분리"
          else
            echo "✅ 모든 컴포넌트가 적절한 크기"
          fi

      - name: Circular Dependencies Check
        run: |
          echo "🔄 순환 의존성 검사..."

          if command -v madge >/dev/null 2>&1; then
            madge --circular --extensions ts,tsx src/
            if [ $? -eq 0 ]; then
              echo "✅ 순환 의존성 없음"
            else
              echo "⚠️ 순환 의존성 발견 - 아키텍처 검토 필요"
            fi
          else
            echo "ℹ️ madge 설치되지 않음 - 순환 의존성 검사 스킵"
          fi
